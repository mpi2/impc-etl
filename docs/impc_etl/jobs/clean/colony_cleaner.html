<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>impc_etl.jobs.clean.colony_cleaner API documentation</title>
<meta name="description" content="Luigi Spark task executable that takes the colonies tracking system
report and returns it ready to be used on the rest of the ETL â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>impc_etl.jobs.clean.colony_cleaner</code></h1>
</header>
<section id="section-intro">
<p>Luigi Spark task executable that takes the colonies tracking system
report and returns it ready to be used on the rest of the ETL.</p>
<p>The cleaning process includes the mapping of legacy colony IDs to newer nomenclature and the generation
of the string representatcion of the genetic background.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;

Luigi Spark task executable that takes the colonies tracking system
report and returns it ready to be used on the rest of the ETL.

The cleaning process includes the mapping of legacy colony IDs to newer nomenclature and the generation
of the string representatcion of the genetic background.

&#34;&#34;&#34;
import sys
from pyspark.sql import SparkSession, DataFrame
from pyspark.sql.functions import udf, col, lit, concat
from pyspark.sql.types import StringType
from impc_etl.shared import utils
from impc_etl.config.constants import Constants


def main(argv):
    imits_colonies_parquet_path = argv[1]
    output_path = argv[2]
    spark = SparkSession.builder.getOrCreate()
    colonies_df = spark.read.parquet(imits_colonies_parquet_path)
    specimen_clean_df = clean_colonies(colonies_df)
    specimen_clean_df.write.mode(&#34;overwrite&#34;).parquet(output_path)


def clean_colonies(colonies_df: DataFrame) -&gt; DataFrame:
    &#34;&#34;&#34;
    DCC colonies cleaner

    Parameters
    __________
    colonies_df: colonies DataFrame with the raw colonies data

    Returns
    _______
    A clean colonies parquet file
    &#34;&#34;&#34;
    colonies_df = colonies_df.transform(map_colonies_df_ids)
    # colonies_df = map_strain_names(colonies_df)
    colonies_df = colonies_df.transform(generate_genetic_background)
    return colonies_df


def map_colonies_df_ids(colonies_df: DataFrame) -&gt; DataFrame:
    colonies_df = colonies_df.withColumn(
        &#34;phenotyping_centre&#34;,
        udf(utils.map_centre_id, StringType())(&#34;phenotyping_centre&#34;),
    )
    colonies_df = colonies_df.withColumn(
        &#34;production_centre&#34;, udf(utils.map_centre_id, StringType())(&#34;production_centre&#34;)
    )
    colonies_df = colonies_df.withColumn(
        &#34;phenotyping_consortium&#34;,
        udf(utils.map_project_id, StringType())(&#34;phenotyping_consortium&#34;),
    )
    colonies_df = colonies_df.withColumn(
        &#34;production_consortium&#34;,
        udf(utils.map_project_id, StringType())(&#34;production_consortium&#34;),
    )
    return colonies_df


def map_strain_names(colonies_df: DataFrame) -&gt; DataFrame:
    map_strain_name_udf = udf(map_strain_name, StringType())
    colonies_df = colonies_df.withColumn(
        &#34;colony_background_strain&#34;, map_strain_name_udf(&#34;colony_background_strain&#34;)
    )
    return colonies_df


def generate_genetic_background(colonies_df: DataFrame) -&gt; DataFrame:
    colonies_df = colonies_df.withColumn(
        &#34;genetic_background&#34;, concat(lit(&#34;involves: &#34;), col(&#34;colony_background_strain&#34;))
    )
    return colonies_df


def map_strain_name(strain_name: str) -&gt; str:
    if strain_name is None:
        return None

    if &#34;_&#34; in strain_name:
        intermediate_backgrounds = strain_name.split(&#34;_&#34;)
    elif &#34;;&#34; in strain_name:
        intermediate_backgrounds = strain_name.split(&#34;;&#34;)
    elif strain_name == &#34;Balb/c.129S2&#34;:
        intermediate_backgrounds = &#34;BALB/c;129S2/SvPas&#34;.split(&#34;;&#34;)
    elif strain_name in [&#34;B6N.129S2.B6J&#34;, &#34;B6J.129S2.B6N&#34;, &#34;B6N.B6J.129S2&#34;]:
        intermediate_backgrounds = &#34;C57BL/6N;129S2/SvPas;C57BL/6J&#34;.split(&#34;;&#34;)
    elif strain_name == &#34;B6J.B6N&#34;:
        intermediate_backgrounds = &#34;C57BL/6J;C57BL/6N&#34;.split(&#34;;&#34;)
    else:
        intermediate_backgrounds = [strain_name]
    intermediate_backgrounds = [
        Constants.BACKGROUND_STRAIN_MAPPER[strain]
        if strain in Constants.BACKGROUND_STRAIN_MAPPER.keys()
        else strain
        for strain in intermediate_backgrounds
    ]

    return &#34;;&#34;.join(intermediate_backgrounds)


if __name__ == &#34;__main__&#34;:
    sys.exit(main(sys.argv))</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="impc_etl.jobs.clean.colony_cleaner.clean_colonies"><code class="name flex">
<span>def <span class="ident">clean_colonies</span></span>(<span>colonies_df:Â pyspark.sql.dataframe.DataFrame) â€‘>Â pyspark.sql.dataframe.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>DCC colonies cleaner</p>
<p>Parameters</p>
<hr>
<p>colonies_df: colonies DataFrame with the raw colonies data</p>
<p>Returns</p>
<hr>
<p>A clean colonies parquet file</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def clean_colonies(colonies_df: DataFrame) -&gt; DataFrame:
    &#34;&#34;&#34;
    DCC colonies cleaner

    Parameters
    __________
    colonies_df: colonies DataFrame with the raw colonies data

    Returns
    _______
    A clean colonies parquet file
    &#34;&#34;&#34;
    colonies_df = colonies_df.transform(map_colonies_df_ids)
    # colonies_df = map_strain_names(colonies_df)
    colonies_df = colonies_df.transform(generate_genetic_background)
    return colonies_df</code></pre>
</details>
</dd>
<dt id="impc_etl.jobs.clean.colony_cleaner.generate_genetic_background"><code class="name flex">
<span>def <span class="ident">generate_genetic_background</span></span>(<span>colonies_df:Â pyspark.sql.dataframe.DataFrame) â€‘>Â pyspark.sql.dataframe.DataFrame</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def generate_genetic_background(colonies_df: DataFrame) -&gt; DataFrame:
    colonies_df = colonies_df.withColumn(
        &#34;genetic_background&#34;, concat(lit(&#34;involves: &#34;), col(&#34;colony_background_strain&#34;))
    )
    return colonies_df</code></pre>
</details>
</dd>
<dt id="impc_etl.jobs.clean.colony_cleaner.main"><code class="name flex">
<span>def <span class="ident">main</span></span>(<span>argv)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def main(argv):
    imits_colonies_parquet_path = argv[1]
    output_path = argv[2]
    spark = SparkSession.builder.getOrCreate()
    colonies_df = spark.read.parquet(imits_colonies_parquet_path)
    specimen_clean_df = clean_colonies(colonies_df)
    specimen_clean_df.write.mode(&#34;overwrite&#34;).parquet(output_path)</code></pre>
</details>
</dd>
<dt id="impc_etl.jobs.clean.colony_cleaner.map_colonies_df_ids"><code class="name flex">
<span>def <span class="ident">map_colonies_df_ids</span></span>(<span>colonies_df:Â pyspark.sql.dataframe.DataFrame) â€‘>Â pyspark.sql.dataframe.DataFrame</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def map_colonies_df_ids(colonies_df: DataFrame) -&gt; DataFrame:
    colonies_df = colonies_df.withColumn(
        &#34;phenotyping_centre&#34;,
        udf(utils.map_centre_id, StringType())(&#34;phenotyping_centre&#34;),
    )
    colonies_df = colonies_df.withColumn(
        &#34;production_centre&#34;, udf(utils.map_centre_id, StringType())(&#34;production_centre&#34;)
    )
    colonies_df = colonies_df.withColumn(
        &#34;phenotyping_consortium&#34;,
        udf(utils.map_project_id, StringType())(&#34;phenotyping_consortium&#34;),
    )
    colonies_df = colonies_df.withColumn(
        &#34;production_consortium&#34;,
        udf(utils.map_project_id, StringType())(&#34;production_consortium&#34;),
    )
    return colonies_df</code></pre>
</details>
</dd>
<dt id="impc_etl.jobs.clean.colony_cleaner.map_strain_name"><code class="name flex">
<span>def <span class="ident">map_strain_name</span></span>(<span>strain_name:Â str) â€‘>Â str</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def map_strain_name(strain_name: str) -&gt; str:
    if strain_name is None:
        return None

    if &#34;_&#34; in strain_name:
        intermediate_backgrounds = strain_name.split(&#34;_&#34;)
    elif &#34;;&#34; in strain_name:
        intermediate_backgrounds = strain_name.split(&#34;;&#34;)
    elif strain_name == &#34;Balb/c.129S2&#34;:
        intermediate_backgrounds = &#34;BALB/c;129S2/SvPas&#34;.split(&#34;;&#34;)
    elif strain_name in [&#34;B6N.129S2.B6J&#34;, &#34;B6J.129S2.B6N&#34;, &#34;B6N.B6J.129S2&#34;]:
        intermediate_backgrounds = &#34;C57BL/6N;129S2/SvPas;C57BL/6J&#34;.split(&#34;;&#34;)
    elif strain_name == &#34;B6J.B6N&#34;:
        intermediate_backgrounds = &#34;C57BL/6J;C57BL/6N&#34;.split(&#34;;&#34;)
    else:
        intermediate_backgrounds = [strain_name]
    intermediate_backgrounds = [
        Constants.BACKGROUND_STRAIN_MAPPER[strain]
        if strain in Constants.BACKGROUND_STRAIN_MAPPER.keys()
        else strain
        for strain in intermediate_backgrounds
    ]

    return &#34;;&#34;.join(intermediate_backgrounds)</code></pre>
</details>
</dd>
<dt id="impc_etl.jobs.clean.colony_cleaner.map_strain_names"><code class="name flex">
<span>def <span class="ident">map_strain_names</span></span>(<span>colonies_df:Â pyspark.sql.dataframe.DataFrame) â€‘>Â pyspark.sql.dataframe.DataFrame</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def map_strain_names(colonies_df: DataFrame) -&gt; DataFrame:
    map_strain_name_udf = udf(map_strain_name, StringType())
    colonies_df = colonies_df.withColumn(
        &#34;colony_background_strain&#34;, map_strain_name_udf(&#34;colony_background_strain&#34;)
    )
    return colonies_df</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<header>
<div style="max-width: 300px, text-align: center">
<img src="https://www.mousephenotype.org/wp-content/themes/impc/images/IMPC_10_YEAR_Logo.svg" alt="IMPC Logo">
</div>
</header>
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="impc_etl.jobs.clean" href="index.html">impc_etl.jobs.clean</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="impc_etl.jobs.clean.colony_cleaner.clean_colonies" href="#impc_etl.jobs.clean.colony_cleaner.clean_colonies">clean_colonies</a></code></li>
<li><code><a title="impc_etl.jobs.clean.colony_cleaner.generate_genetic_background" href="#impc_etl.jobs.clean.colony_cleaner.generate_genetic_background">generate_genetic_background</a></code></li>
<li><code><a title="impc_etl.jobs.clean.colony_cleaner.main" href="#impc_etl.jobs.clean.colony_cleaner.main">main</a></code></li>
<li><code><a title="impc_etl.jobs.clean.colony_cleaner.map_colonies_df_ids" href="#impc_etl.jobs.clean.colony_cleaner.map_colonies_df_ids">map_colonies_df_ids</a></code></li>
<li><code><a title="impc_etl.jobs.clean.colony_cleaner.map_strain_name" href="#impc_etl.jobs.clean.colony_cleaner.map_strain_name">map_strain_name</a></code></li>
<li><code><a title="impc_etl.jobs.clean.colony_cleaner.map_strain_names" href="#impc_etl.jobs.clean.colony_cleaner.map_strain_names">map_strain_names</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p><span></span></p>
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>